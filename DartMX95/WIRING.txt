================================================================================
      WIRING: ESP32 WROOM + L298N + DART-MX95 + STEERING SERVO
                      VISION-BASED HUMAN FOLLOWING CAR
================================================================================

SYSTEM OVERVIEW
---------------
- DART-MX95: Vision processing, YOLO detection, ROS2 control system
- ESP32 WROOM: Real-time motor controller (receives commands via UART)
- L298N: Dual H-Bridge motor driver for DC motors
- CAM2C CUM10330_MOD: USB-C camera for human detection and tracking
- Steering Servo: Controlled by ESP32 for navigation

Signal Flow:
  Camera --> DART-MX95 --[Vision Processing]--> ROS2 Node
  ROS2 --> ESP32 --[Real-time Control]--> L298N --> Motors + Servo

Architecture Philosophy:
- DART-MX95: High-level intelligence (vision, planning, decision making)
- ESP32: Low-level execution (precise motor timing, safety systems)

================================================================================
                          POWER DISTRIBUTION
================================================================================

                         MAIN BATTERY (7-12V)
                                   |
                +------------------+------------------+
                |                                     |
                v                                     v
           L298N +12V                            12V to DART-MX95
                |                                (via J30 DC jack)
    +-----------+-----------+                         |
    |           |           |                         v
    v           v           v                   DART-MX95 Internal
 Motors     L298N 5V    L298N GND               Power Management
            Regulator        |                         |
                |            |           +-------------+-------------+
                |            |           |             |             |
                v            |           v             v             v
        Servo 5V (HS-85MG)   |      USB-C Camera   J6 Header    ESP32 Power
                |            |      Power (J33)      5V           via J6
                +------+-----+                       |             |
                       |                             +-------------+
                  COMMON GND

Power Requirements:
- Main Battery: 7-12V, 5A capacity recommended
- L298N 5V regulator: Powers Servo only (~800mA peak for HS-85MG)
- DART-MX95: Self-powered via 12V DC input + powers ESP32 via J6 header
- ESP32: Powered from DART-MX95 J6 header 5V (~150mA)
- Camera: USB-C powered directly from DART-MX95
- Hitec HS-85MG Servo: High-performance metal gear servo, 5V, 800mA stall

================================================================================
                              WIRING DIAGRAM
================================================================================

                     DART-MX95 (Sonata Carrier)
        +----------------------------------------+
        |                                        |
        |  J30 (12V DC) <-- Wall Adapter         |
        |  J33 (USB-C) <--- CAM2C Camera         |
        |                                        |
        |  J32 (USB Debug) - for development     |
        |                                        |
        |  J6 (UART/I2C Header)                  |
        |  +---+---+---+---+---+---+---+---+    |
        |  |5V |GND| TX| RX|   |   |   |   |    |
        |  +---+---+---+---+---+---+---+---+    |
        |    |   |   |   |                      |
        |    |   |   |   +-------> ESP32 GPIO16 (RX)
        |    |   |   +-----------> ESP32 GPIO17 (TX)
        |    |   +-----------> ESP32 GND        |
        |    +--------------> ESP32 VIN (5V)    |
        |                                        |
        +----------------------------------------+


                       ESP32 WROOM
                   +------------------+
                   |      USB         |
                   |                  |
              3V3  | o            o | VIN <-------- DART-MX95 J6 Pin 1 (5V)
              GND  | o            o | GND --------> DART-MX95 J6 Pin 2 (GND)
              D15  | o            o | D13 (GPIO13) -> IN4
              D2   | o            o | D12 (GPIO12) -> IN3
              D4   | o            o | D14 (GPIO14) -> ENB
         RX2  D16  | o            o | D27 (GPIO27) -> IN2
         TX2  D17  | o            o | D26 (GPIO26) -> IN1
              D5   | o            o | D25 (GPIO25) -> ENA
              D18  | o            o | D33 ---------> Servo Signal
              D19  | o            o | D32
              D21  | o            o | D35
              D22  | o            o | D34
              D23  | o            o | VN
                   |      EN  BOOT  |
                   +------------------+

UART Communication:
- ESP32 GPIO16 (RX2) <-- DART-MX95 UART TX
- ESP32 GPIO17 (TX2) --> DART-MX95 UART RX
- Common GND connection


                      L298N MODULE
        +------------------------------------+
        |                                    |
        |  +12V  GND  +5V                    |
        |   o     o    o                     |
        |   ^     ^    +-- To Servo 5V (HS-85MG)  |
        |   |     +------- Common Ground     |
        |   +------------- Main Battery +    |
        |                                    |
        |  [5V REG JUMPER] <-- Must be ON    |
        |                                    |
        |  ENA  IN1  IN2  IN3  IN4  ENB      |
        |   o    o    o    o    o    o       |
        +------------------------------------+
            |    |    |    |    |    |
            |    |    |    |    |    +-------> GPIO14
            |    |    |    |    +-----------> GPIO13
            |    |    |    +----------------> GPIO12
            |    |    +---------------------> GPIO27
            |    +--------------------------> GPIO26
            +-------------------------------> GPIO25


                HITEC HS-85MG SERVO
                   +--------------+
                   |              |
                   |   Signal o---+---> ESP32 GPIO33
                   |      5V  o---+---> L298N 5V Output
                   |     GND  o---+---> Common GND
                   |              |
                   | Metal Gear   |
                   | Digital Servo|
                   +--------------+


                   CAM2C CUM10330_MOD
                   +--------------+
                   |    Camera    |
                   |   Module     |
                   +--------------+
                           |
                      USB-C Cable
                           |
                           v
                   DART-MX95 J33 (USB-C OTG)

================================================================================
                          CONNECTION TABLE
================================================================================

ESP32 TO L298N:
---------------
ESP32 Pin     L298N Pin     Function
---------     ---------     --------
GPIO25        ENA           Motor A PWM (Left)
GPIO26        IN1           Motor A Direction A
GPIO27        IN2           Motor A Direction B
GPIO12        IN3           Motor B Direction A
GPIO13        IN4           Motor B Direction B
GPIO14        ENB           Motor B PWM (Right)

ESP32 TO HITEC HS-85MG SERVO:
-----------------------------
ESP32 Pin     Servo Pin     Function
---------     ---------     --------
GPIO33        Signal        Servo PWM Control (50Hz, 1-2ms pulse width)

DART-MX95 TO ESP32 (UART + Power):
----------------------------------
DART Pin      ESP32 Pin     Function
--------      ---------     --------
J6 Pin 1 (5V) VIN           ESP32 Power Supply
J6 Pin 2 (GND) GND          Common Ground
J6 Pin 3 (TX) GPIO16 (RX2)  Command transmission
J6 Pin 4 (RX) GPIO17 (TX2)  Status feedback

CAMERA CONNECTION:
------------------
Camera        DART-MX95     Function
------        ---------     --------
USB-C         J33 (USB-C)   Video data + Power

POWER CONNECTIONS:
------------------
Source        Destination   Function
------        -----------   --------
Main Battery  L298N +12V    Motor power
Main Battery  DART DC Jack  System power
DART-MX95 J6  ESP32 VIN     ESP32 power (5V, 150mA)
L298N 5V      Servo VCC     HS-85MG power (5V, 800mA peak)

MOTORS:
-------
Motor A (Left):  L298N OUT1/OUT2
Motor B (Right): L298N OUT3/OUT4

================================================================================
                     GROUND CONNECTIONS (CRITICAL!)
================================================================================

All grounds MUST be connected together in a star configuration:

  +-- Main Battery GND
  |
  +-- L298N GND terminal
  |
  +-- ESP32 GND (via DART-MX95 J6 Pin 2)
  |
  +-- DART-MX95 GND (via J6 header and power jack)
  |
  +-- Hitec HS-85MG Servo GND

Use thick gauge wire (16 AWG minimum) for ground connections.
Keep ground wires as short as possible to minimize noise.

================================================================================
                    COMMUNICATION PROTOCOL (UART)
================================================================================

DART-MX95 to ESP32 Commands (115200 baud, 8N1):
------------------------------------------------
MOTOR <motor> <direction> <speed>
  motor: A or B
  direction: FORWARD, BACKWARD, STOP
  speed: 0-100 (percentage)
  Example: "MOTOR A FORWARD 75\n"

SERVO <angle>
  angle: 0-180 degrees
  Example: "SERVO 90\n"

STOP
  Emergency stop all motors
  Example: "STOP\n"

STATUS
  Request ESP32 status
  Example: "STATUS\n"

ESP32 to DART-MX95 Responses:
-----------------------------
OK
  Command executed successfully

ERROR <message>
  Command failed with reason

STATUS motor_a:<speed> motor_b:<speed> servo:<angle>
  Current system status
  Example: "STATUS motor_a:75 motor_b:50 servo:90\n"

WATCHDOG
  Periodic heartbeat (sent every 500ms)

================================================================================
                          WIRING CHECKLIST
================================================================================

POWER:
[ ] Main battery to L298N +12V terminal
[ ] Main battery to DART-MX95 12V DC jack (J30)
[ ] L298N 5V jumper installed (ON position)
[ ] DART-MX95 J6 Pin 1 (5V) to ESP32 VIN
[ ] DART-MX95 J6 Pin 2 (GND) to ESP32 GND
[ ] L298N 5V to Hitec HS-85MG Servo VCC

MOTOR CONTROL (ESP32 to L298N):
[ ] GPIO25 to ENA (Motor A PWM)
[ ] GPIO26 to IN1 (Motor A Dir A)
[ ] GPIO27 to IN2 (Motor A Dir B)
[ ] GPIO12 to IN3 (Motor B Dir A)
[ ] GPIO13 to IN4 (Motor B Dir B)
[ ] GPIO14 to ENB (Motor B PWM)

SERVO CONTROL:
[ ] ESP32 GPIO33 to Hitec HS-85MG signal wire

COMMUNICATION (UART):
[ ] DART-MX95 J6 Pin 3 (TX) to ESP32 GPIO16 (RX2)
[ ] DART-MX95 J6 Pin 4 (RX) to ESP32 GPIO17 (TX2)

CAMERA:
[ ] CAM2C CUM10330_MOD USB-C to DART-MX95 J33

MOTORS:
[ ] Motor A (Left) to L298N OUT1/OUT2
[ ] Motor B (Right) to L298N OUT3/OUT4

GROUND (CRITICAL):
[ ] All device grounds connected in star configuration
[ ] Thick gauge ground wires used
[ ] Ground connections verified with multimeter

SAFETY:
[ ] Emergency stop button accessible
[ ] Battery disconnect switch installed
[ ] Fuses installed on main power lines

================================================================================
                          TROUBLESHOOTING
================================================================================

ESP32 not responding:
  - Check power: 5V at ESP32 VIN pin from DART-MX95 J6
  - Verify DART-MX95 is powered and booted
  - Check UART wiring (TX/RX may be swapped on J6 header)
  - Test with ESP32 USB connection for debugging

Motors don't move:
  - Verify common ground connections
  - Check battery voltage (should be 7-12V)
  - Test L298N independently with multimeter
  - Send STATUS command to check ESP32 response

Camera not detected:
  - Check USB-C connection to J33
  - Verify camera power LED (if present)
  - Test with: ls /dev/video*
  - Try different USB-C cable

Communication errors:
  - Verify UART baud rate (115200)
  - Check TX/RX connections (may be reversed)
  - Test with minicom or similar terminal program
  - Ensure common ground between devices

Hitec HS-85MG servo jittering:
  - Check 5V power stability at servo (L298N regulator)
  - Verify PWM signal with oscilloscope (50Hz, 1-2ms pulse)
  - HS-85MG requires stable 5V and can draw 800mA peak
  - Add large capacitor (1000ÂµF) across servo power if needed
  - Ensure L298N 5V regulator can handle servo current

DART-MX95 not booting:
  - Check 12V power at DC jack
  - Verify switch settings (SW1=ON, SW10=ON)
  - Check for short circuits
  - Try booting without peripherals connected

================================================================================
                        NEXT STEPS: SOFTWARE SETUP
================================================================================

1. Flash ESP32 with motor control firmware
2. Set up ROS2 environment on DART-MX95
3. Install camera drivers and YOLO detection
4. Configure UART communication between systems
5. Implement human following algorithm
6. Add safety systems and emergency stops

Refer to companion software documentation for implementation details.

================================================================================